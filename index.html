<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Signal Test v2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        
        .container {
            max-width: 480px;
            width: 100%;
            border: 1px solid #fff;
            padding: 1.5rem;
        }
        
        h1 {
            font-size: 1.1rem;
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 1.5rem;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 0.75rem;
        }
        
        .status-panel {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #333;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.4rem;
            font-size: 0.8rem;
        }
        
        .status-label { color: #666; }
        .status-value { font-weight: bold; }
        
        .signal-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin: 1rem 0 0.5rem;
        }
        
        .signal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
            border: 1px solid #555;
            transition: all 0.1s;
        }
        
        .signal-dot.active {
            background: #fff;
            box-shadow: 0 0 15px #fff;
        }
        
        .timer {
            font-size: 2.5rem;
            text-align: center;
            margin: 1rem 0;
            font-weight: bold;
            letter-spacing: 0.1em;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .timer.active { animation: pulse 1s infinite; }
        
        .log-panel {
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            border: 1px solid #333;
            height: 140px;
            overflow-y: auto;
            font-size: 0.7rem;
            background: #0a0a0a;
        }
        
        .log-entry { margin-bottom: 0.25rem; color: #888; }
        .log-entry.signal { color: #fff; }
        .log-entry.error { color: #fff; background: #500; padding: 0.15rem 0.3rem; }
        .log-entry .ts { color: #444; margin-right: 0.4rem; }
        
        .button-row { display: flex; gap: 0.75rem; }
        
        button {
            flex: 1;
            background: #fff;
            color: #000;
            border: none;
            padding: 0.9rem 1.5rem;
            font-family: inherit;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        button:hover:not(:disabled) { background: #ccc; }
        button:active:not(:disabled) { background: #999; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        button.secondary {
            background: transparent;
            color: #fff;
            border: 1px solid #fff;
        }
        
        button.secondary:hover:not(:disabled) { background: #fff; color: #000; }
        button.secondary:disabled { border-color: #333; color: #333; }
        
        .progress-bar {
            width: 100%;
            height: 3px;
            background: #222;
            margin-top: 1.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: #fff;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        .instructions {
            margin-top: 1.5rem;
            font-size: 0.65rem;
            color: #555;
            text-align: center;
            line-height: 1.5;
        }
        
        .freq-display {
            text-align: center;
            font-size: 0.7rem;
            color: #444;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Audio Signal Test v2</h1>
        
        <div class="status-panel">
            <div class="status-row">
                <span class="status-label">Mode</span>
                <span class="status-value" id="mode">IDLE</span>
            </div>
            <div class="status-row">
                <span class="status-label">Signals Sent</span>
                <span class="status-value" id="signals-sent">0</span>
            </div>
            <div class="status-row">
                <span class="status-label">Signals Received</span>
                <span class="status-value" id="signals-received">0</span>
            </div>
            <div class="status-row">
                <span class="status-label">Detection</span>
                <span class="status-value" id="detection">—</span>
            </div>
            
            <div class="signal-indicator">
                <span style="font-size: 0.65rem; color: #666;">TX</span>
                <div class="signal-dot" id="tx-indicator"></div>
                <span style="margin: 0 0.75rem; color: #333;">|</span>
                <div class="signal-dot" id="rx-indicator"></div>
                <span style="font-size: 0.65rem; color: #666;">RX</span>
            </div>
            <div class="freq-display" id="freq-display">—</div>
        </div>
        
        <div class="timer" id="timer">00:10</div>
        
        <div class="log-panel" id="log"></div>
        
        <div class="button-row">
            <button id="btn-init" onclick="init()">⚡ INIT</button>
            <button id="btn-test" onclick="startTest()" style="display:none;">▶ TEST</button>
            <button id="btn-reset" class="secondary" onclick="resetAll()">↻ RESET</button>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        
        <div class="instructions">
            Pure Web Audio API - No external libraries<br>
            Uses FSK: 1800Hz = signal, silence = no signal<br>
            Open on 2 devices → INIT both → TEST on one
        </div>
    </div>

    <script>
        // ============================================
        // AUDIO SIGNAL TEST v2
        // Pure Web Audio API implementation
        // Uses simple FSK (Frequency Shift Keying)
        // ============================================
        
        // Configuration
        const SIGNAL_FREQ = 1800;      // Hz - the tone frequency
        const SAMPLE_RATE = 44100;     // Standard sample rate
        const FFT_SIZE = 2048;         // FFT analysis size
        const DETECTION_THRESHOLD = 15; // dB above noise floor
        
        // State
        let audioCtx = null;
        let analyser = null;
        let micStream = null;
        let oscillator = null;
        let gainNode = null;
        let isInitialized = false;
        let isTestRunning = false;
        let isSending = false;
        let testInterval = null;
        let detectInterval = null;
        let timeRemaining = 10;
        let signalsSent = 0;
        let signalsReceived = 0;
        let lastDetection = false;
        
        // DOM
        const $ = id => document.getElementById(id);
        const elMode = $('mode');
        const elSignalsSent = $('signals-sent');
        const elSignalsReceived = $('signals-received');
        const elDetection = $('detection');
        const elTimer = $('timer');
        const elLog = $('log');
        const elProgress = $('progress');
        const elBtnInit = $('btn-init');
        const elBtnTest = $('btn-test');
        const elTxIndicator = $('tx-indicator');
        const elRxIndicator = $('rx-indicator');
        const elFreqDisplay = $('freq-display');
        
        // Logging
        function log(msg, type = 'info') {
            const ts = new Date().toLocaleTimeString('en-US', {
                hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            const el = document.createElement('div');
            el.className = `log-entry ${type}`;
            el.innerHTML = `<span class="ts">[${ts}]</span>${msg}`;
            elLog.appendChild(el);
            elLog.scrollTop = elLog.scrollHeight;
            console.log(`[${type}] ${msg}`);
        }
        
        function updateTimer(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            elTimer.textContent = `${m}:${s}`;
        }
        
        function flash(el, dur = 200) {
            el.classList.add('active');
            setTimeout(() => el.classList.remove('active'), dur);
        }
        
        // Initialize audio
        async function init() {
            if (isInitialized) {
                log('Already initialized');
                return;
            }
            
            elBtnInit.disabled = true;
            elMode.textContent = 'INIT...';
            log('Initializing...');
            
            try {
                // Step 1: Create AudioContext
                log('Creating AudioContext...');
                const AC = window.AudioContext || window.webkitAudioContext;
                if (!AC) throw new Error('AudioContext not supported');
                
                audioCtx = new AC({ sampleRate: SAMPLE_RATE });
                log(`AudioContext: ${audioCtx.state}, ${audioCtx.sampleRate}Hz`);
                
                // Resume if suspended
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                    log('AudioContext resumed');
                }
                
                // Step 2: Get microphone
                log('Requesting microphone...');
                if (!navigator.mediaDevices?.getUserMedia) {
                    throw new Error('getUserMedia not supported');
                }
                
                micStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                log('Microphone access granted ✓', 'signal');
                
                // Step 3: Create analyser for frequency detection
                log('Setting up analyser...');
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = FFT_SIZE;
                analyser.smoothingTimeConstant = 0.3;
                
                const source = audioCtx.createMediaStreamSource(micStream);
                source.connect(analyser);
                log('Analyser connected ✓');
                
                // Step 4: Create oscillator for transmission (not started yet)
                gainNode = audioCtx.createGain();
                gainNode.gain.value = 0;
                gainNode.connect(audioCtx.destination);
                
                oscillator = audioCtx.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.value = SIGNAL_FREQ;
                oscillator.connect(gainNode);
                oscillator.start();
                log('Oscillator ready ✓');
                
                // Step 5: Start detection loop
                startDetection();
                
                // Success
                isInitialized = true;
                elMode.textContent = 'READY';
                elBtnInit.style.display = 'none';
                elBtnTest.style.display = 'block';
                log('═══════════════════', 'signal');
                log('INIT COMPLETE', 'signal');
                log(`Listening at ${SIGNAL_FREQ}Hz`, 'signal');
                log('═══════════════════', 'signal');
                
            } catch (err) {
                log(`ERROR: ${err.name}: ${err.message}`, 'error');
                elMode.textContent = 'ERROR';
                elBtnInit.disabled = false;
                
                if (err.name === 'NotAllowedError') {
                    log('→ Microphone permission denied', 'error');
                    log('→ Check Chrome settings', 'error');
                }
            }
        }
        
        // Frequency detection
        function startDetection() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const binWidth = audioCtx.sampleRate / analyser.fftSize;
            const targetBin = Math.round(SIGNAL_FREQ / binWidth);
            
            log(`Target bin: ${targetBin} (${(targetBin * binWidth).toFixed(1)}Hz)`);
            
            detectInterval = setInterval(() => {
                if (!analyser) return;
                
                analyser.getByteFrequencyData(dataArray);
                
                // Get power at target frequency
                const targetPower = dataArray[targetBin];
                
                // Get average power (noise floor)
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const avgPower = sum / bufferLength;
                
                // Calculate signal-to-noise
                const snr = targetPower - avgPower;
                
                // Detect signal
                const detected = snr > DETECTION_THRESHOLD && targetPower > 50;
                
                // Update display
                elFreqDisplay.textContent = `${SIGNAL_FREQ}Hz: ${targetPower} | Avg: ${avgPower.toFixed(0)} | SNR: ${snr.toFixed(0)}`;
                
                if (detected && !lastDetection && !isSending) {
                    // Rising edge - signal just detected
                    signalsReceived++;
                    elSignalsReceived.textContent = signalsReceived;
                    flash(elRxIndicator, 300);
                    elDetection.textContent = 'SIGNAL!';
                    log(`RX: Signal detected! (SNR: ${snr.toFixed(1)})`, 'signal');
                } else if (detected && !isSending) {
                    elDetection.textContent = 'SIGNAL';
                    elRxIndicator.classList.add('active');
                } else {
                    elDetection.textContent = '—';
                    elRxIndicator.classList.remove('active');
                }
                
                lastDetection = detected;
                
            }, 100); // Check 10 times per second
        }
        
        // Send a tone burst
        function sendTone(durationMs) {
            if (!gainNode) return;
            
            isSending = true;
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            flash(elTxIndicator, durationMs);
            
            setTimeout(() => {
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                isSending = false;
            }, durationMs);
        }
        
        // Start test
        function startTest() {
            if (!isInitialized) {
                log('Please INIT first', 'error');
                return;
            }
            if (isTestRunning) return;
            
            isTestRunning = true;
            timeRemaining = 10;
            signalsSent = 0;
            elSignalsSent.textContent = '0';
            elBtnTest.disabled = true;
            elMode.textContent = 'TESTING';
            elTimer.classList.add('active');
            
            log('═══ TEST START ═══', 'signal');
            log('Sending signals...', 'signal');
            
            // Send initial burst
            sendSignal();
            
            updateTimer(timeRemaining);
            
            testInterval = setInterval(() => {
                timeRemaining--;
                updateTimer(timeRemaining);
                elProgress.style.width = `${((10 - timeRemaining) / 10) * 100}%`;
                
                // Send signal every 2 seconds
                if (timeRemaining % 2 === 0 && timeRemaining > 0) {
                    sendSignal();
                }
                
                if (timeRemaining <= 0) {
                    endTest();
                }
            }, 1000);
        }
        
        function sendSignal() {
            signalsSent++;
            elSignalsSent.textContent = signalsSent;
            log(`TX: Signal #${signalsSent} (${SIGNAL_FREQ}Hz, 500ms)`);
            sendTone(500); // 500ms tone burst
        }
        
        function endTest() {
            isTestRunning = false;
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            elTimer.classList.remove('active');
            elBtnTest.disabled = false;
            elMode.textContent = 'DONE';
            elProgress.style.width = '100%';
            
            log('═══ TEST END ═══', 'signal');
            log(`Sent: ${signalsSent} | Received: ${signalsReceived}`, 'signal');
        }
        
        function resetAll() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            isTestRunning = false;
            timeRemaining = 10;
            signalsSent = 0;
            signalsReceived = 0;
            
            updateTimer(10);
            elSignalsSent.textContent = '0';
            elSignalsReceived.textContent = '0';
            elDetection.textContent = '—';
            elProgress.style.width = '0%';
            elTimer.classList.remove('active');
            elBtnTest.disabled = false;
            elMode.textContent = isInitialized ? 'READY' : 'IDLE';
            
            elLog.innerHTML = '';
            log('Reset complete');
            if (isInitialized) {
                log(`Listening at ${SIGNAL_FREQ}Hz`);
            }
        }
        
        // Init on load
        document.addEventListener('DOMContentLoaded', () => {
            log('Audio Signal Test v2');
            log('Pure Web Audio API');
            log('───────────────────');
            log('1. Tap INIT');
            log('2. Allow microphone');
            log('3. Tap TEST to send');
            log('───────────────────');
            updateTimer(10);
        });
    </script>
</body>
</html>
