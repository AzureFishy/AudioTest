<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Signal Test v11</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #000; color: #fff; min-height: 100vh; padding: 1rem; }
        .container { max-width: 520px; margin: 0 auto; border: 1px solid #fff; padding: 1.25rem; }
        h1 { font-size: 1rem; font-weight: normal; text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 1rem; text-align: center; border-bottom: 1px solid #333; padding-bottom: 0.5rem; }
        .section { margin-bottom: 0.75rem; padding: 0.6rem; border: 1px solid #333; }
        .section.tx { border-color: #0a0; }
        .section.rx { border-color: #0aa; }
        .section-title { font-size: 0.65rem; color: #666; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.4rem; }
        .section.tx .section-title { color: #0f0; }
        .section.rx .section-title { color: #0ff; }
        .row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem; font-size: 0.7rem; }
        .row:last-child { margin-bottom: 0; }
        .row label { color: #888; min-width: 50px; }
        input[type="range"] { flex: 1; height: 4px; -webkit-appearance: none; background: #333; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #fff; cursor: pointer; border-radius: 50%; }
        .section.tx input[type="range"]::-webkit-slider-thumb { background: #0f0; }
        .section.rx input[type="range"]::-webkit-slider-thumb { background: #0ff; }
        input[type="number"] { width: 70px; background: #111; border: 1px solid #444; color: #fff; padding: 0.25rem 0.3rem; font-family: inherit; font-size: 0.7rem; text-align: center; }
        input[type="number"]:focus { outline: none; border-color: #fff; }
        .hz { font-size: 0.6rem; color: #666; }
        .range-display { font-size: 0.6rem; color: #666; margin-left: auto; }
        .section.tx .range-display { color: #0a0; }
        .section.rx .range-display { color: #0aa; }
        .binary-row { display: flex; align-items: center; gap: 0.3rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #222; }
        .binary-label { font-size: 0.6rem; color: #666; min-width: 45px; }
        .section.tx .binary-label { color: #0a0; }
        .section.rx .binary-label { color: #0aa; }
        .toggle-group { display: flex; gap: 2px; }
        .bit-toggle { width: 28px; height: 32px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; border: 1px solid #333; border-radius: 3px; cursor: pointer; transition: all 0.15s; position: relative; }
        .bit-toggle:hover { border-color: #555; }
        .bit-toggle.on { background: #0a0; border-color: #0f0; }
        .section.rx .bit-toggle.on { background: #088; border-color: #0ff; }
        .bit-toggle .bit-num { font-size: 0.5rem; color: #555; position: absolute; top: 2px; }
        .bit-toggle.on .bit-num { color: #000; }
        .bit-toggle .bit-val { font-size: 0.75rem; font-weight: bold; color: #444; }
        .bit-toggle.on .bit-val { color: #000; }
        .binary-string { font-size: 0.65rem; color: #555; font-family: inherit; letter-spacing: 0.05em; margin-left: auto; }
        .section.tx .binary-string { color: #0a0; }
        .section.rx .binary-string { color: #0aa; }
        .ascii-char { font-size: 0.7rem; font-weight: bold; margin-left: 0.3rem; padding: 0.1rem 0.3rem; background: #1a1a1a; border-radius: 2px; }
        .section.tx .ascii-char { color: #0f0; border: 1px solid #0a0; }
        .section.rx .ascii-char { color: #0ff; border: 1px solid #0aa; }
        .freq-info { font-size: 0.55rem; color: #444; margin-top: 0.3rem; text-align: center; }
        .air-toggle { display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin: 1rem 0; flex-wrap: wrap; }
        .air-btn { padding: 0.5rem 1.5rem; font-family: inherit; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border: 2px solid #444; background: #111; color: #666; border-radius: 4px; transition: all 0.2s; }
        .air-btn:hover { border-color: #666; }
        .air-btn.on { background: #f00; color: #fff; border-color: #f00; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); animation: air-pulse 1.5s infinite; }
        @keyframes air-pulse { 0%, 100% { box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); } 50% { box-shadow: 0 0 25px rgba(255, 0, 0, 0.8); } }
        .pulse-group { display: flex; align-items: center; gap: 0.3rem; }
        .pulse-btn { padding: 0.5rem 0.75rem; font-family: inherit; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border: 2px solid #0a0; background: #111; color: #0f0; border-radius: 4px; transition: all 0.1s; }
        .pulse-btn:hover { background: #0a0; color: #000; }
        .pulse-btn:active { background: #0f0; }
        .pulse-btn:disabled { border-color: #333; color: #333; cursor: not-allowed; }
        .pulse-btn:disabled:hover { background: #111; color: #333; }
        .pulse-input { width: 50px; background: #111; border: 1px solid #0a0; color: #0f0; padding: 0.35rem 0.25rem; font-family: inherit; font-size: 0.65rem; text-align: center; border-radius: 3px; }
        .pulse-input:focus { outline: none; border-color: #0f0; }
        .pulse-label { font-size: 0.55rem; color: #0a0; }
        .graph-section { margin-bottom: 0.75rem; }
        .graph-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; gap: 0.5rem; flex-wrap: wrap; }
        .graph-title { font-size: 0.6rem; color: #666; text-transform: uppercase; }
        .graph-controls { display: flex; align-items: center; gap: 0.2rem; flex-wrap: wrap; }
        .zoom-btn { width: 20px; height: 20px; font-family: inherit; font-size: 0.8rem; font-weight: bold; background: #111; color: #888; border: 1px solid #444; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; }
        .zoom-btn:hover { background: #222; color: #fff; border-color: #666; }
        .zoom-btn:active { background: #333; }
        .zoom-toggle { padding: 0.15rem 0.35rem; font-family: inherit; font-size: 0.55rem; font-weight: bold; background: #111; color: #555; border: 1px solid #333; border-radius: 3px; cursor: pointer; text-transform: uppercase; }
        .zoom-toggle:hover { border-color: #555; color: #888; }
        .zoom-toggle.tx-on { background: #0a0; color: #000; border-color: #0f0; }
        .zoom-toggle.rx-on { background: #088; color: #000; border-color: #0ff; }
        .zoom-input { width: 45px; background: #111; border: 1px solid #333; color: #888; padding: 0.2rem; font-family: inherit; font-size: 0.55rem; text-align: center; border-radius: 2px; }
        .zoom-input:focus { outline: none; border-color: #666; color: #fff; }
        .zoom-sep { color: #333; font-size: 0.5rem; }
        .graph-container { border: 1px solid #222; background: #050505; position: relative; overflow: hidden; }
        #graph { width: 100%; height: 100px; display: block; }
        .detection-info { text-align: center; font-size: 0.6rem; color: #555; min-height: 1.1em; padding: 0.25rem 0; }
        .match-status { text-align: center; font-size: 0.7rem; padding: 0.3rem; margin-bottom: 0.5rem; border: 1px solid #333; background: #0a0a0a; }
        .match-status.match { color: #0f0; border-color: #0a0; background: #001a00; }
        .match-status.no-match { color: #888; }
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
        .log-title { font-size: 0.6rem; color: #666; text-transform: uppercase; }
        .log-count { font-size: 0.55rem; color: #555; }
        .log-panel { height: 90px; overflow-y: auto; background: #050505; padding: 0.4rem; font-size: 0.6rem; border: 1px solid #222; margin-bottom: 0.75rem; }
        .log-entry { margin-bottom: 0.15rem; color: #555; }
        .log-entry.rx { color: #0ff; }
        .log-entry.tx { color: #0f0; }
        .log-entry.info { color: #888; }
        .log-entry.err { color: #f00; }
        .log-entry.match { color: #0f0; font-weight: bold; }
        .log-entry .ts { color: #333; margin-right: 0.25rem; }
        .log-entry .pattern { color: #ff0; }
        .log-entry .ascii { color: #0ff; font-weight: bold; }
        .timer { text-align: center; font-size: 1.3rem; font-weight: bold; margin: 0.3rem 0; }
        .timer.active { animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.4; } }
        .button-row { display: flex; gap: 0.5rem; }
        button.main-btn { flex: 1; padding: 0.6rem; font-family: inherit; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; border: none; transition: all 0.15s; }
        .btn-init { background: #fff; color: #000; }
        .btn-test { background: #0f0; color: #000; }
        .btn-reset { background: transparent; color: #fff; border: 1px solid #555 !important; }
        button.main-btn:disabled { background: #333; color: #666; cursor: not-allowed; }
        button.main-btn:hover:not(:disabled) { opacity: 0.8; }
        .progress { height: 2px; background: #222; margin-top: 0.75rem; }
        .progress-fill { height: 100%; background: #0f0; width: 0%; transition: width 0.1s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Audio Signal Test v11</h1>
        
        <div class="section tx">
            <div class="section-title">▲ Transmit</div>
            <div class="row">
                <label>Base</label>
                <input type="range" id="tx-slider" min="20" max="30000" step="10" value="1800">
                <input type="number" id="tx-input" value="1800" min="1" max="30000" step="1">
                <span class="hz">Hz</span>
            </div>
            <div class="row">
                <label>Step</label>
                <input type="number" id="tx-step" value="10" min="1" max="500" step="1" style="width:50px;">
                <span class="hz">Hz</span>
                <span class="range-display" id="tx-range-display"></span>
            </div>
            <div class="row">
                <label>Ignore ±</label>
                <input type="number" id="tx-tolerance" value="4" min="1" max="100" step="1" style="width:50px;">
                <span class="hz">Hz</span>
                <span class="range-display">per bit</span>
            </div>
            <div class="binary-row">
                <span class="binary-label">Binary</span>
                <div class="toggle-group" id="tx-toggles"></div>
                <span class="binary-string" id="tx-binary">00000000</span>
                <span class="ascii-char" id="tx-ascii">(NUL)</span>
            </div>
            <div class="freq-info" id="tx-freq-info"></div>
        </div>
        
        <div class="section rx">
            <div class="section-title">▼ Receive Pattern</div>
            <div class="row">
                <label>Base</label>
                <input type="range" id="rx-slider" min="20" max="30000" step="10" value="1800">
                <input type="number" id="rx-input" value="1800" min="1" max="30000" step="1">
                <span class="hz">Hz</span>
            </div>
            <div class="row">
                <label>Step</label>
                <input type="number" id="rx-step" value="10" min="1" max="500" step="1" style="width:50px;">
                <span class="hz">Hz</span>
                <span class="range-display" id="rx-range-display"></span>
            </div>
            <div class="row">
                <label>Detect ±</label>
                <input type="number" id="rx-tolerance" value="4" min="1" max="100" step="1" style="width:50px;">
                <span class="hz">Hz</span>
                <span class="range-display">per bit</span>
            </div>
            <div class="row">
                <label>Thresh</label>
                <input type="number" id="rx-thresh" value="40" min="5" max="200" step="5" style="width:50px;">
                <span class="hz">pwr</span>
                <span class="range-display">detection</span>
            </div>
            <div class="row">
                <label>Window</label>
                <input type="number" id="rx-window" value="300" min="10" max="2000" step="10" style="width:50px;">
                <span class="hz">ms</span>
                <span class="range-display">debounce</span>
            </div>
            <div class="row">
                <label>Poll</label>
                <input type="number" id="poll-interval" value="50" min="10" max="500" step="10" style="width:50px;">
                <span class="hz">ms</span>
                <span class="range-display" id="poll-display">~20/sec</span>
            </div>
            <div class="binary-row">
                <span class="binary-label">Expect</span>
                <div class="toggle-group" id="rx-toggles"></div>
                <span class="binary-string" id="rx-binary">00000000</span>
                <span class="ascii-char" id="rx-ascii">(NUL)</span>
            </div>
            <div class="freq-info" id="rx-freq-info"></div>
        </div>
        
        <div class="air-toggle">
            <button class="air-btn" id="btn-air" onclick="toggleAir()">OFF AIR</button>
            <div class="pulse-group">
                <button class="pulse-btn" id="btn-pulse" onclick="manualPulse()" disabled>PULSE</button>
                <input type="number" id="pulse-duration" class="pulse-input" value="350" min="5" max="5000" step="5">
                <span class="pulse-label">ms</span>
            </div>
        </div>
        
        <div class="graph-section">
            <div class="graph-header">
                <span class="graph-title">Spectrum</span>
                <div class="graph-controls">
                    <button class="zoom-toggle" id="zoom-tx" onclick="toggleZoomTx()">Tx</button>
                    <button class="zoom-toggle" id="zoom-rx" onclick="toggleZoomRx()">Rx</button>
                    <span class="zoom-sep">│</span>
                    <button class="zoom-btn" onclick="zoomGraph(-1)">−</button>
                    <input type="number" id="hz-min" class="zoom-input" value="0" min="0" max="30000" step="100">
                    <span class="zoom-sep">–</span>
                    <input type="number" id="hz-max" class="zoom-input" value="4000" min="0" max="30000" step="100">
                    <span class="zoom-sep">Hz</span>
                    <button class="zoom-btn" onclick="zoomGraph(1)">+</button>
                    <span class="zoom-sep">│</span>
                    <input type="number" id="pwr-min" class="zoom-input" value="0" min="0" max="255" step="5">
                    <span class="zoom-sep">–</span>
                    <input type="number" id="pwr-max" class="zoom-input" value="255" min="0" max="255" step="5">
                    <span class="zoom-sep">pwr</span>
                </div>
            </div>
            <div class="graph-container">
                <canvas id="graph"></canvas>
            </div>
        </div>
        
        <div class="detection-info" id="detection-info">—</div>
        <div class="match-status no-match" id="match-status">Detected: <span id="detected-pattern">--------</span></div>
        <div class="timer" id="timer">00:10</div>
        
        <div class="log-header">
            <span class="log-title">Log</span>
            <span class="log-count" id="log-count">0 entries</span>
        </div>
        <div class="log-panel" id="log"></div>
        
        <div class="button-row">
            <button class="main-btn btn-init" id="btn-init" onclick="init()">⚡ INIT</button>
            <button class="main-btn btn-test" id="btn-test" onclick="startTest()" style="display:none;">▶ TEST</button>
            <button class="main-btn btn-reset" onclick="resetAll()">↻</button>
        </div>
        <div class="progress"><div class="progress-fill" id="progress"></div></div>
    </div>

    <script>
        const FFT_SIZE = 8192, NUM_BITS = 8;
        const ZOOM_LEVELS = [500, 1000, 2000, 4000, 8000, 12000, 20000, 30000];
        let zoomIndex = 3;
        
        let hzMin = 0, hzMax = 4000, pwrMin = 0, pwrMax = 255;
        let zoomTxOn = false, zoomRxOn = false;
        let flashQueue = [], charFlashQueue = [];
        let audioCtx, analyser, micStream, oscillators = [], gainNodes = [];
        let detectInterval, testInterval, frequencyData;
        let isInit = false, isRunning = false, isSending = false, isOnAir = false;
        let txBaseFreq = 1800, txStep = 10, txTolerance = 4, txToggles = [0,0,0,0,0,0,0,0];
        let rxBaseFreq = 1800, rxStep = 10, rxTolerance = 4, rxThreshold = 40, rxWindow = 300, pollInterval = 50, rxToggles = [0,0,0,0,0,0,0,0];
        let pulseDuration = 350, timeLeft = 10, lastDetectTime = 0, lastDetectedPattern = '', logEntryCount = 0;
        let graphCanvas, graphCtx;
        
        const $ = id => document.getElementById(id);
        const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
        const togglesToString = t => t.map(x => x ? '1' : '0').join('');
        const getAllFreqs = (base, step) => Array.from({length: NUM_BITS}, (_, i) => base + i * step);
        const getActiveFreqs = (base, step, toggles) => getAllFreqs(base, step).filter((_, i) => toggles[i]);
        
        const binaryToAscii = b => parseInt(b, 2);
        const ctrlChars = {0:'NUL',1:'SOH',2:'STX',3:'ETX',4:'EOT',5:'ENQ',6:'ACK',7:'BEL',8:'BS',9:'TAB',10:'LF',11:'VT',12:'FF',13:'CR',14:'SO',15:'SI',16:'DLE',17:'DC1',18:'DC2',19:'DC3',20:'DC4',21:'NAK',22:'SYN',23:'ETB',24:'CAN',25:'EM',26:'SUB',27:'ESC',28:'FS',29:'GS',30:'RS',31:'US',32:'SPC',127:'DEL'};
        const getAsciiDisplay = c => ctrlChars[c] !== undefined ? `(${ctrlChars[c]})` : (c >= 33 && c <= 126) ? `'${String.fromCharCode(c)}'` : `(x${c.toString(16).toUpperCase()})`;
        const charSymbols = {0:'∅',8:'⌫',9:'⇥',10:'↵',13:'↩',32:'␣',127:'⌦'};
        const getAsciiChar = c => charSymbols[c] || (c >= 33 && c <= 126 ? String.fromCharCode(c) : '?');
        
        function log(msg, type = '') {
            if (!isOnAir && type !== 'info' && isInit) return;
            const now = new Date();
            const ts = now.toLocaleTimeString('en-US', {hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}) + '.' + now.getMilliseconds().toString().padStart(3,'0');
            const el = document.createElement('div');
            el.className = `log-entry ${type}`;
            el.innerHTML = `<span class="ts">[${ts}]</span>${msg}`;
            $('log').appendChild(el);
            $('log').scrollTop = $('log').scrollHeight;
            $('log-count').textContent = `${++logEntryCount} entries`;
        }
        
        function updateTimer() {
            $('timer').textContent = `${Math.floor(timeLeft/60).toString().padStart(2,'0')}:${(timeLeft%60).toString().padStart(2,'0')}`;
        }
        
        // Zoom functions
        function getTxRange() {
            const min = txBaseFreq - txTolerance - txStep;
            const max = txBaseFreq + (NUM_BITS - 1) * txStep + txTolerance + txStep;
            return { min, max };
        }
        
        function getRxRange() {
            const min = rxBaseFreq - rxTolerance - rxStep;
            const max = rxBaseFreq + (NUM_BITS - 1) * rxStep + rxTolerance + rxStep;
            return { min, max };
        }
        
        function applyZoomToggles() {
            if (!zoomTxOn && !zoomRxOn) return;
            
            let minHz = Infinity, maxHz = -Infinity;
            
            if (zoomTxOn) {
                const tx = getTxRange();
                minHz = Math.min(minHz, tx.min);
                maxHz = Math.max(maxHz, tx.max);
            }
            
            if (zoomRxOn) {
                const rx = getRxRange();
                minHz = Math.min(minHz, rx.min);
                maxHz = Math.max(maxHz, rx.max);
            }
            
            hzMin = Math.max(0, Math.floor(minHz));
            hzMax = Math.ceil(maxHz);
            updateZoomInputs();
        }
        
        function toggleZoomTx() {
            zoomTxOn = !zoomTxOn;
            $('zoom-tx').classList.toggle('tx-on', zoomTxOn);
            applyZoomToggles();
        }
        
        function toggleZoomRx() {
            zoomRxOn = !zoomRxOn;
            $('zoom-rx').classList.toggle('rx-on', zoomRxOn);
            applyZoomToggles();
        }
        
        function zoomGraph(dir) {
            // Clear zoom toggles when manually zooming
            zoomTxOn = false;
            zoomRxOn = false;
            $('zoom-tx').classList.remove('tx-on');
            $('zoom-rx').classList.remove('rx-on');
            
            zoomIndex = clamp(zoomIndex + dir, 0, ZOOM_LEVELS.length - 1);
            hzMax = ZOOM_LEVELS[zoomIndex];
            hzMin = 0;
            updateZoomInputs();
        }
        
        function updateZoomInputs() {
            $('hz-min').value = hzMin;
            $('hz-max').value = hzMax;
            $('pwr-min').value = pwrMin;
            $('pwr-max').value = pwrMax;
        }
        
        function readZoomInputs() {
            // Clear zoom toggles when manually editing
            zoomTxOn = false;
            zoomRxOn = false;
            $('zoom-tx').classList.remove('tx-on');
            $('zoom-rx').classList.remove('rx-on');
            
            hzMin = clamp(parseInt($('hz-min').value) || 0, 0, 30000);
            hzMax = clamp(parseInt($('hz-max').value) || 4000, hzMin + 100, 30000);
            pwrMin = clamp(parseInt($('pwr-min').value) || 0, 0, 255);
            pwrMax = clamp(parseInt($('pwr-max').value) || 255, pwrMin + 10, 255);
            updateZoomInputs();
        }
        
        $('hz-min').onchange = $('hz-max').onchange = $('pwr-min').onchange = $('pwr-max').onchange = readZoomInputs;
        
        function triggerFlash() { flashQueue.push({ startTime: performance.now() }); }
        function triggerCharFlash(char) { charFlashQueue.push({ startTime: performance.now(), char }); }
        
        function calculateFlashIntensity() {
            const now = performance.now();
            let intensity = 0;
            flashQueue = flashQueue.filter(f => {
                const elapsed = now - f.startTime;
                if (elapsed > 700) return false;
                intensity += elapsed < 200 ? 0.5 : 0.5 * (1 - (elapsed - 200) / 500);
                return true;
            });
            return Math.min(intensity, 1);
        }
        
        function getCharFlashState() {
            const now = performance.now();
            let result = { char: null, opacity: 0 };
            charFlashQueue = charFlashQueue.filter(f => {
                const elapsed = now - f.startTime;
                if (elapsed > 1000) return false;
                const opacity = elapsed < 300 ? Math.min(1, elapsed / 100) : 1 - (elapsed - 300) / 700;
                if (opacity > result.opacity) result = { char: f.char, opacity };
                return true;
            });
            return result;
        }
        
        function createToggles(containerId, toggleArray, updateCallback) {
            const container = $(containerId);
            container.innerHTML = '';
            for (let i = 0; i < NUM_BITS; i++) {
                const btn = document.createElement('div');
                btn.className = 'bit-toggle' + (toggleArray[i] ? ' on' : '');
                btn.innerHTML = `<span class="bit-num">${i + 1}</span><span class="bit-val">${toggleArray[i]}</span>`;
                btn.onclick = () => {
                    toggleArray[i] = toggleArray[i] ? 0 : 1;
                    btn.classList.toggle('on', toggleArray[i]);
                    btn.querySelector('.bit-val').textContent = toggleArray[i];
                    updateCallback();
                };
                container.appendChild(btn);
            }
        }
        
        function updateTxDisplay() {
            const b = togglesToString(txToggles);
            $('tx-binary').textContent = b;
            $('tx-ascii').textContent = getAsciiDisplay(binaryToAscii(b));
            $('tx-range-display').textContent = `${txBaseFreq}–${txBaseFreq + 7*txStep} Hz`;
            const active = getActiveFreqs(txBaseFreq, txStep, txToggles);
            $('tx-freq-info').textContent = active.length ? `Active: ${active.map(f => `${f}±${txTolerance}`).join(', ')} Hz` : 'No frequencies selected';
            if (zoomTxOn) applyZoomToggles();
        }
        
        function updateRxDisplay() {
            const b = togglesToString(rxToggles);
            $('rx-binary').textContent = b;
            $('rx-ascii').textContent = getAsciiDisplay(binaryToAscii(b));
            $('rx-range-display').textContent = `${rxBaseFreq}–${rxBaseFreq + 7*rxStep} Hz`;
            const active = getActiveFreqs(rxBaseFreq, rxStep, rxToggles);
            $('rx-freq-info').textContent = active.length ? `Expecting: ${active.map(f => `${f}±${rxTolerance}`).join(', ')} Hz` : 'No pattern set';
            if (zoomRxOn) applyZoomToggles();
        }
        
        const updateTxBaseFreq = f => { txBaseFreq = clamp(Math.round(f), 1, 30000); $('tx-input').value = txBaseFreq; $('tx-slider').value = clamp(txBaseFreq, 20, 30000); updateTxDisplay(); };
        const updateRxBaseFreq = f => { rxBaseFreq = clamp(Math.round(f), 1, 30000); $('rx-input').value = rxBaseFreq; $('rx-slider').value = clamp(rxBaseFreq, 20, 30000); updateRxDisplay(); };
        
        $('tx-slider').oninput = () => updateTxBaseFreq(+$('tx-slider').value);
        $('tx-input').onchange = () => updateTxBaseFreq(+$('tx-input').value || 1);
        $('tx-step').onchange = () => { txStep = clamp(+$('tx-step').value || 10, 1, 500); updateTxDisplay(); };
        $('tx-tolerance').onchange = () => { txTolerance = clamp(+$('tx-tolerance').value || 4, 1, 100); updateTxDisplay(); };
        $('rx-slider').oninput = () => updateRxBaseFreq(+$('rx-slider').value);
        $('rx-input').onchange = () => updateRxBaseFreq(+$('rx-input').value || 1);
        $('rx-step').onchange = () => { rxStep = clamp(+$('rx-step').value || 10, 1, 500); updateRxDisplay(); };
        $('rx-tolerance').onchange = () => { rxTolerance = clamp(+$('rx-tolerance').value || 4, 1, 100); updateRxDisplay(); };
        $('rx-thresh').onchange = () => { rxThreshold = clamp(+$('rx-thresh').value || 40, 5, 200); };
        $('rx-window').onchange = () => { rxWindow = +$('rx-window').value || 300; };
        $('poll-interval').onchange = () => { 
            pollInterval = clamp(+$('poll-interval').value || 50, 10, 500); 
            $('poll-display').textContent = `~${Math.round(1000/pollInterval)}/sec`;
            if (isInit && detectInterval) { clearInterval(detectInterval); startDetection(); }
        };
        $('pulse-duration').onchange = () => { pulseDuration = clamp(+$('pulse-duration').value || 350, 5, 5000); };
        
        function toggleAir() {
            if (!isInit) return;
            isOnAir = !isOnAir;
            $('btn-air').classList.toggle('on', isOnAir);
            $('btn-air').textContent = isOnAir ? 'ON AIR' : 'OFF AIR';
            if (isOnAir) {
                log('════════════════', 'info');
                log('ON AIR', 'rx');
                log(`TX: ${togglesToString(txToggles)} @ ${txBaseFreq}Hz +${txStep}Hz (±${txTolerance}Hz)`, 'info');
                log(`RX: ${togglesToString(rxToggles)} @ ${rxBaseFreq}Hz +${rxStep}Hz (±${rxTolerance}Hz)`, 'info');
            } else {
                log('OFF AIR', 'info');
                $('detection-info').textContent = '—';
                $('match-status').className = 'match-status no-match';
                $('detected-pattern').textContent = '--------';
            }
        }
        
        function manualPulse() {
            if (!isInit || isSending) return;
            if (!isOnAir) toggleAir();
            sendSignal();
        }
        
        function setupGraph() {
            graphCanvas = $('graph');
            graphCtx = graphCanvas.getContext('2d');
            const rect = graphCanvas.getBoundingClientRect();
            graphCanvas.width = rect.width * devicePixelRatio;
            graphCanvas.height = rect.height * devicePixelRatio;
            graphCtx.scale(devicePixelRatio, devicePixelRatio);
        }
        
        function drawGraph() {
            if (!graphCtx) { requestAnimationFrame(drawGraph); return; }
            
            const w = graphCanvas.width / devicePixelRatio;
            const h = graphCanvas.height / devicePixelRatio;
            const flashIntensity = calculateFlashIntensity();
            const charFlash = getCharFlashState();
            const hzRange = hzMax - hzMin;
            const pwrRange = pwrMax - pwrMin;
            
            graphCtx.fillStyle = flashIntensity > 0 ? `rgb(${5}, ${5 + 80*flashIntensity}, ${5 + 80*flashIntensity})` : '#050505';
            graphCtx.fillRect(0, 0, w, h);
            
            const hzToX = hz => ((hz - hzMin) / hzRange) * w;
            
            // TX bands (green) - width matches ±tolerance
            const txFreqs = getAllFreqs(txBaseFreq, txStep);
            for (let i = 0; i < NUM_BITS; i++) {
                const freq = txFreqs[i];
                if (freq + txTolerance < hzMin || freq - txTolerance > hzMax) continue;
                
                // Band width = 2 * tolerance (from -tolerance to +tolerance)
                const x1 = hzToX(freq - txTolerance);
                const x2 = hzToX(freq + txTolerance);
                const bandWidth = Math.max(x2 - x1, 1); // minimum 1px
                
                // More transparent fills (reduced ~20%)
                graphCtx.fillStyle = txToggles[i] ? 'rgba(0, 255, 0, 0.10)' : 'rgba(0, 255, 0, 0.03)';
                graphCtx.fillRect(x1, 0, bandWidth, h);
                
                // Center line - more transparent
                graphCtx.strokeStyle = txToggles[i] ? 'rgba(0, 255, 0, 0.4)' : 'rgba(0, 255, 0, 0.12)';
                graphCtx.beginPath(); 
                graphCtx.moveTo(hzToX(freq), 0); 
                graphCtx.lineTo(hzToX(freq), h); 
                graphCtx.stroke();
            }
            
            // RX bands (blue) - width matches ±tolerance
            const rxFreqs = getAllFreqs(rxBaseFreq, rxStep);
            for (let i = 0; i < NUM_BITS; i++) {
                const freq = rxFreqs[i];
                if (freq + rxTolerance < hzMin || freq - rxTolerance > hzMax) continue;
                
                // Band width = 2 * tolerance
                const x1 = hzToX(freq - rxTolerance);
                const x2 = hzToX(freq + rxTolerance);
                const bandWidth = Math.max(x2 - x1, 1);
                
                // More transparent fills (reduced ~20%)
                graphCtx.fillStyle = rxToggles[i] ? 'rgba(0, 150, 255, 0.10)' : 'rgba(0, 150, 255, 0.03)';
                graphCtx.fillRect(x1, 0, bandWidth, h);
                
                // Center line - more transparent
                graphCtx.strokeStyle = rxToggles[i] ? 'rgba(0, 200, 255, 0.4)' : 'rgba(0, 150, 255, 0.12)';
                graphCtx.beginPath(); 
                graphCtx.moveTo(hzToX(freq), 0); 
                graphCtx.lineTo(hzToX(freq), h); 
                graphCtx.stroke();
                
                // Bit number
                graphCtx.fillStyle = rxToggles[i] ? 'rgba(0, 200, 255, 0.6)' : 'rgba(100, 100, 100, 0.3)';
                graphCtx.font = '8px Courier New';
                graphCtx.fillText(i + 1, hzToX(freq) - 3, 10);
            }
            
            // Spectrum
            if (isOnAir && analyser) {
                analyser.getByteFrequencyData(frequencyData);
                const binW = audioCtx.sampleRate / analyser.fftSize;
                const startBin = Math.max(0, Math.floor(hzMin / binW));
                const endBin = Math.min(frequencyData.length, Math.ceil(hzMax / binW));
                
                for (let i = startBin; i < endBin; i++) {
                    const freq = i * binW, pwr = frequencyData[i];
                    if (pwr < pwrMin) continue;
                    const x = hzToX(freq);
                    const barH = ((Math.min(pwr, pwrMax) - pwrMin) / pwrRange) * h;
                    const v = pwr / 255;
                    
                    let inTx = txToggles.some((t, j) => t && Math.abs(freq - txFreqs[j]) <= txTolerance);
                    let inRx = rxToggles.some((t, j) => t && Math.abs(freq - rxFreqs[j]) <= rxTolerance);
                    
                    graphCtx.fillStyle = (inTx && isSending) ? `rgba(0, 255, 0, ${0.4 + v * 0.6})` : 
                                         inRx ? `rgba(0, 200, 255, ${0.3 + v * 0.7})` : 
                                         `rgba(100, 100, 100, ${0.2 + v * 0.6})`;
                    
                    graphCtx.fillRect(x, h - barH, Math.max(w / (endBin - startBin) - 1, 1), barH);
                }
            }
            
            // Threshold
            if (rxThreshold >= pwrMin && rxThreshold <= pwrMax) {
                const threshY = h - ((rxThreshold - pwrMin) / pwrRange) * h;
                graphCtx.strokeStyle = 'rgba(255, 255, 0, 0.3)';
                graphCtx.setLineDash([3, 3]);
                graphCtx.beginPath(); 
                graphCtx.moveTo(0, threshY); 
                graphCtx.lineTo(w, threshY); 
                graphCtx.stroke();
                graphCtx.setLineDash([]);
            }
            
            // Freq markers
            graphCtx.fillStyle = '#444';
            graphCtx.font = '9px Courier New';
            const step = hzRange <= 500 ? 100 : hzRange <= 1000 ? 200 : hzRange <= 4000 ? 500 : hzRange <= 10000 ? 2000 : 5000;
            for (let f = Math.ceil(hzMin / step) * step; f <= hzMax; f += step) {
                graphCtx.fillText(f >= 1000 ? `${f/1000}k` : f, hzToX(f) - 10, h - 2);
            }
            
            // Char flash
            if (charFlash.char && charFlash.opacity > 0) {
                graphCtx.save();
                graphCtx.font = 'bold 48px Courier New';
                graphCtx.textAlign = 'center';
                graphCtx.textBaseline = 'middle';
                graphCtx.shadowColor = `rgba(0, 255, 255, ${charFlash.opacity})`;
                graphCtx.shadowBlur = 20;
                graphCtx.fillStyle = `rgba(0, 255, 255, ${charFlash.opacity})`;
                graphCtx.fillText(charFlash.char, w / 2, h / 2);
                graphCtx.restore();
            }
            
            requestAnimationFrame(drawGraph);
        }
        
        async function init() {
            if (isInit) return;
            $('btn-init').disabled = true;
            log('Initializing...', 'info');
            
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                log(`AudioContext: ${audioCtx.sampleRate}Hz`, 'info');
                
                micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });
                log('Mic ready ✓', 'rx');
                
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = FFT_SIZE;
                analyser.smoothingTimeConstant = 0.3;
                audioCtx.createMediaStreamSource(micStream).connect(analyser);
                frequencyData = new Uint8Array(analyser.frequencyBinCount);
                
                for (let i = 0; i < NUM_BITS; i++) {
                    const gain = audioCtx.createGain();
                    gain.gain.value = 0;
                    gain.connect(audioCtx.destination);
                    gainNodes.push(gain);
                    const osc = audioCtx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.value = txBaseFreq + i * txStep;
                    osc.connect(gain);
                    osc.start();
                    oscillators.push(osc);
                }
                
                setupGraph();
                startDetection();
                requestAnimationFrame(drawGraph);
                
                isInit = true;
                $('btn-init').style.display = 'none';
                $('btn-test').style.display = 'block';
                $('btn-pulse').disabled = false;
                
                log('════════════════', 'info');
                log('READY — Toggle ON AIR to begin', 'rx');
            } catch (e) {
                log(`ERROR: ${e.message}`, 'err');
                $('btn-init').disabled = false;
            }
        }
        
        function startDetection() {
            const binW = audioCtx.sampleRate / analyser.fftSize;
            const data = new Uint8Array(analyser.frequencyBinCount);
            
            detectInterval = setInterval(() => {
                if (!analyser || !isOnAir) return;
                if (isSending) { $('detection-info').textContent = `TX: ${togglesToString(txToggles)}`; return; }
                
                analyser.getByteFrequencyData(data);
                const rxFreqs = getAllFreqs(rxBaseFreq, rxStep);
                const detected = [], powers = [];
                
                for (let i = 0; i < NUM_BITS; i++) {
                    const freq = rxFreqs[i];
                    const lo = Math.max(0, Math.floor((freq - rxTolerance) / binW));
                    const hi = Math.min(data.length - 1, Math.ceil((freq + rxTolerance) / binW));
                    let maxP = 0;
                    for (let b = lo; b <= hi; b++) if (data[b] > maxP) maxP = data[b];
                    powers.push(maxP);
                    detected.push(maxP >= rxThreshold ? 1 : 0);
                }
                
                const detStr = togglesToString(detected);
                const expStr = togglesToString(rxToggles);
                const charCode = binaryToAscii(detStr);
                
                $('detection-info').textContent = `Powers: [${powers.join(', ')}] | Max: ${Math.max(...powers)}`;
                $('detected-pattern').textContent = `${detStr} ${getAsciiDisplay(charCode)}`;
                
                if (detected.some(b => b)) {
                    const now = Date.now();
                    if (now - lastDetectTime > rxWindow || detStr !== lastDetectedPattern) {
                        lastDetectTime = now;
                        lastDetectedPattern = detStr;
                        const isMatch = detStr === expStr;
                        $('match-status').className = `match-status ${isMatch ? 'match' : 'no-match'}`;
                        
                        if (isMatch) {
                            log(`✓ MATCH: <span class="pattern">${detStr}</span> <span class="ascii">${getAsciiDisplay(charCode)}</span>`, 'match');
                            triggerFlash();
                            triggerCharFlash(getAsciiChar(charCode));
                        } else {
                            log(`RX: <span class="pattern">${detStr}</span> ${getAsciiDisplay(charCode)} (expected ${expStr})`, 'rx');
                        }
                    }
                }
            }, pollInterval);
        }
        
        function sendTone(dur) {
            if (!gainNodes.length) return;
            isSending = true;
            for (let i = 0; i < NUM_BITS; i++) {
                oscillators[i].frequency.setValueAtTime(txBaseFreq + i * txStep, audioCtx.currentTime);
                gainNodes[i].gain.setValueAtTime(txToggles[i] ? 0.15 : 0, audioCtx.currentTime);
            }
            setTimeout(() => {
                gainNodes.forEach(g => g.gain.setValueAtTime(0, audioCtx.currentTime));
                setTimeout(() => { isSending = false; }, 80);
            }, dur);
        }
        
        function sendSignal() {
            const b = togglesToString(txToggles);
            log(`TX: ${b} ${getAsciiDisplay(binaryToAscii(b))} (${txToggles.filter(t=>t).length} tones, ${pulseDuration}ms)`, 'tx');
            sendTone(pulseDuration);
        }
        
        function startTest() {
            if (!isInit || isRunning) return;
            if (!isOnAir) toggleAir();
            isRunning = true;
            timeLeft = 10;
            $('btn-test').disabled = true;
            $('timer').classList.add('active');
            log('═══ TEST ═══', 'tx');
            sendSignal();
            updateTimer();
            testInterval = setInterval(() => {
                timeLeft--;
                updateTimer();
                $('progress').style.width = `${((10 - timeLeft) / 10) * 100}%`;
                if (timeLeft % 2 === 0 && timeLeft > 0) sendSignal();
                if (timeLeft <= 0) endTest();
            }, 1000);
        }
        
        function endTest() {
            isRunning = false;
            clearInterval(testInterval);
            $('timer').classList.remove('active');
            $('btn-test').disabled = false;
            $('progress').style.width = '100%';
            log('═══ DONE ═══', 'rx');
        }
        
        function resetAll() {
            clearInterval(testInterval);
            isRunning = false;
            timeLeft = 10;
            updateTimer();
            $('progress').style.width = '0%';
            $('timer').classList.remove('active');
            $('btn-test').disabled = false;
            $('detection-info').textContent = '—';
            $('log').innerHTML = '';
            flashQueue = [];
            charFlashQueue = [];
            logEntryCount = 0;
            lastDetectedPattern = '';
            $('detected-pattern').textContent = '--------';
            $('match-status').className = 'match-status no-match';
            $('log-count').textContent = '0 entries';
            log('Reset', 'info');
            if (isInit) log(`TX: ${togglesToString(txToggles)} @ ${txBaseFreq}Hz | RX: ${togglesToString(rxToggles)} @ ${rxBaseFreq}Hz`, 'info');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            createToggles('tx-toggles', txToggles, updateTxDisplay);
            createToggles('rx-toggles', rxToggles, updateRxDisplay);
            updateTxBaseFreq(txBaseFreq);
            updateRxBaseFreq(rxBaseFreq);
            updateZoomInputs();
            $('poll-display').textContent = `~${Math.round(1000/pollInterval)}/sec`;
            setupGraph();
            requestAnimationFrame(drawGraph);
            log('Audio Signal Test v11', 'info');
            log('───────────────────', 'info');
            log('Tx/Rx toggles auto-zoom', 'info');
            log('Green = TX | Blue = RX', 'info');
            log('INIT → ON AIR → PULSE', 'info');
        });
        
        window.addEventListener('resize', () => { if (graphCanvas) setupGraph(); });
    </script>
</body>
</html>
