<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiet.js Audio Signal Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace;
            background: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        h1 {
            font-size: 1.2rem;
            font-weight: 400;
            margin-bottom: 8px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        
        .subtitle {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 40px;
        }
        
        #status {
            border: 1px solid #333;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 120px;
            font-size: 0.8rem;
            text-align: left;
            background: #0a0a0a;
        }
        
        .status-line {
            margin: 6px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .status-label { color: #666; }
        .status-value { color: #fff; }
        .status-value.active { color: #0f0; }
        .status-value.error { color: #f00; }
        .status-value.warning { color: #ff0; }
        
        #testBtn {
            background: #fff;
            color: #000;
            border: none;
            padding: 16px 48px;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.15em;
            cursor: pointer;
            transition: all 0.15s;
            text-transform: uppercase;
        }
        
        #testBtn:hover:not(:disabled) {
            background: #ccc;
        }
        
        #testBtn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        #testBtn.transmitting {
            background: #0f0;
            color: #000;
            animation: pulse 0.5s infinite alternate;
        }
        
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
        
        #timer {
            font-size: 2rem;
            font-weight: 300;
            margin: 30px 0;
            font-family: monospace;
        }
        
        #log {
            margin-top: 30px;
            border: 1px solid #222;
            padding: 15px;
            font-size: 0.7rem;
            text-align: left;
            max-height: 150px;
            overflow-y: auto;
            background: #050505;
            color: #555;
        }
        
        #log .entry { margin: 3px 0; }
        #log .entry.rx { color: #0a0; }
        #log .entry.tx { color: #00a; }
        #log .entry.err { color: #a00; }
        
        .note {
            font-size: 0.65rem;
            color: #444;
            margin-top: 40px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Audio Signal Test</h1>
        <p class="subtitle">Quiet.js Wireless Communication</p>
        
        <div id="status">
            <div class="status-line">
                <span class="status-label">Library:</span>
                <span class="status-value" id="libStatus">Loading...</span>
            </div>
            <div class="status-line">
                <span class="status-label">Receiver:</span>
                <span class="status-value" id="rxStatus">—</span>
            </div>
            <div class="status-line">
                <span class="status-label">Transmitter:</span>
                <span class="status-value" id="txStatus">—</span>
            </div>
            <div class="status-line">
                <span class="status-label">Signals RX:</span>
                <span class="status-value" id="rxCount">0</span>
            </div>
            <div class="status-line">
                <span class="status-label">Last Message:</span>
                <span class="status-value" id="lastMsg">—</span>
            </div>
        </div>
        
        <div id="timer">—</div>
        
        <button id="testBtn" disabled>Initializing</button>
        
        <div id="log"></div>
        
        <p class="note">
            Open this page on two devices. Press TEST to transmit.<br>
            Uses audible frequencies (~4kHz). Chrome/Edge recommended.<br>
            Requires HTTPS for microphone access in production.
        </p>
    </div>

    <!-- Quiet.js Library -->
    <script src="https://cdn.jsdelivr.net/gh/quiet/quiet-js@master/quiet.js"></script>
    <script>
        // Configure paths BEFORE loading emscripten
        Quiet.setProfilesPrefix("https://cdn.jsdelivr.net/gh/quiet/quiet-js@master/");
        Quiet.setMemoryInitializerPrefix("https://cdn.jsdelivr.net/gh/quiet/quiet-js@master/");
    </script>
    <script async src="https://cdn.jsdelivr.net/gh/quiet/quiet-js@master/quiet-emscripten.js"></script>
    
    <script>
    (function() {
        'use strict';
        
        // DOM elements
        const libStatus = document.getElementById('libStatus');
        const rxStatus = document.getElementById('rxStatus');
        const txStatus = document.getElementById('txStatus');
        const rxCount = document.getElementById('rxCount');
        const lastMsg = document.getElementById('lastMsg');
        const timerEl = document.getElementById('timer');
        const testBtn = document.getElementById('testBtn');
        const logEl = document.getElementById('log');
        
        // State
        let transmitter = null;
        let receiver = null;
        let isTransmitting = false;
        let signalsReceived = 0;
        let testInterval = null;
        let testSecondsLeft = 0;
        
        // Configuration
        const PROFILE = 'audible';  // Good cross-browser compatibility
        const TEST_DURATION = 10;   // seconds
        const PING_INTERVAL = 800;  // ms between pings
        
        // Logging
        function log(msg, type = '') {
            const entry = document.createElement('div');
            entry.className = 'entry ' + type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logEl.insertBefore(entry, logEl.firstChild);
            if (logEl.children.length > 50) {
                logEl.removeChild(logEl.lastChild);
            }
        }
        
        // Generate unique test message
        function generatePing() {
            const id = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `PING:${id}:${Date.now()}`;
        }
        
        // Initialize receiver
        function initReceiver() {
            rxStatus.textContent = 'Starting...';
            rxStatus.className = 'status-value warning';
            
            try {
                Quiet.receiver({
                    profile: PROFILE,
                    onReceive: function(payload) {
                        const message = Quiet.ab2str(payload);
                        signalsReceived++;
                        rxCount.textContent = signalsReceived;
                        rxCount.className = 'status-value active';
                        lastMsg.textContent = message.substring(0, 20);
                        lastMsg.className = 'status-value active';
                        log(`RX: ${message}`, 'rx');
                        
                        // Flash effect
                        setTimeout(() => {
                            rxCount.className = 'status-value';
                            lastMsg.className = 'status-value';
                        }, 500);
                    },
                    onCreate: function() {
                        receiver = true;
                        rxStatus.textContent = 'Listening';
                        rxStatus.className = 'status-value active';
                        log('Receiver ready', 'rx');
                        checkReady();
                    },
                    onCreateFail: function(reason) {
                        rxStatus.textContent = 'Failed';
                        rxStatus.className = 'status-value error';
                        log(`Receiver failed: ${reason}`, 'err');
                    },
                    onReceiveFail: function(count) {
                        log(`Checksum fail #${count}`, 'err');
                    }
                });
            } catch (e) {
                rxStatus.textContent = 'Error';
                rxStatus.className = 'status-value error';
                log(`Receiver error: ${e.message}`, 'err');
            }
        }
        
        // Initialize transmitter
        function initTransmitter() {
            txStatus.textContent = 'Starting...';
            txStatus.className = 'status-value warning';
            
            try {
                transmitter = Quiet.transmitter({
                    profile: PROFILE,
                    onFinish: function() {
                        // Called when transmission queue is empty
                    }
                });
                txStatus.textContent = 'Ready';
                txStatus.className = 'status-value active';
                log('Transmitter ready', 'tx');
                checkReady();
            } catch (e) {
                txStatus.textContent = 'Error';
                txStatus.className = 'status-value error';
                log(`Transmitter error: ${e.message}`, 'err');
            }
        }
        
        // Check if everything is ready
        function checkReady() {
            if (transmitter && receiver) {
                testBtn.disabled = false;
                testBtn.textContent = 'TEST';
                timerEl.textContent = `${TEST_DURATION}s`;
            }
        }
        
        // Start test transmission
        function startTest() {
            if (isTransmitting) return;
            
            isTransmitting = true;
            testSecondsLeft = TEST_DURATION;
            testBtn.classList.add('transmitting');
            testBtn.textContent = 'TRANSMITTING';
            testBtn.disabled = true;
            
            log(`Starting ${TEST_DURATION}s test`, 'tx');
            
            // Update timer
            function updateTimer() {
                timerEl.textContent = `${testSecondsLeft}s`;
                if (testSecondsLeft <= 0) {
                    stopTest();
                } else {
                    testSecondsLeft--;
                }
            }
            
            // Send pings
            function sendPing() {
                if (!isTransmitting) return;
                
                const msg = generatePing();
                try {
                    transmitter.transmit(Quiet.str2ab(msg));
                    log(`TX: ${msg}`, 'tx');
                } catch (e) {
                    log(`TX error: ${e.message}`, 'err');
                }
            }
            
            // Initial ping
            sendPing();
            updateTimer();
            
            // Set up intervals
            testInterval = setInterval(sendPing, PING_INTERVAL);
            const timerInterval = setInterval(() => {
                updateTimer();
                if (testSecondsLeft < 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }
        
        // Stop test
        function stopTest() {
            isTransmitting = false;
            
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            testBtn.classList.remove('transmitting');
            testBtn.textContent = 'TEST';
            testBtn.disabled = false;
            timerEl.textContent = `${TEST_DURATION}s`;
            
            log('Test complete', 'tx');
        }
        
        // Button handler - needs user interaction to start AudioContext
        testBtn.addEventListener('click', function() {
            if (!isTransmitting) {
                startTest();
            }
        });
        
        // Initialize when Quiet.js is ready
        Quiet.addReadyCallback(function() {
            libStatus.textContent = 'Ready';
            libStatus.className = 'status-value active';
            log('Quiet.js loaded');
            
            // Need user interaction for AudioContext in modern browsers
            testBtn.disabled = false;
            testBtn.textContent = 'CLICK TO INIT';
            
            testBtn.addEventListener('click', function initOnClick() {
                testBtn.removeEventListener('click', initOnClick);
                testBtn.disabled = true;
                testBtn.textContent = 'INITIALIZING...';
                
                // Initialize components
                initTransmitter();
                initReceiver();
            }, { once: true });
        }, function(reason) {
            libStatus.textContent = 'Failed';
            libStatus.className = 'status-value error';
            log(`Library failed: ${reason}`, 'err');
        });
        
        // Timeout fallback
        setTimeout(function() {
            if (libStatus.textContent === 'Loading...') {
                libStatus.textContent = 'Timeout';
                libStatus.className = 'status-value error';
                log('Library load timeout - check network/CORS', 'err');
            }
        }, 15000);
        
    })();
    </script>
</body>
</html>
